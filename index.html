<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Chart Race - Fluid Engine</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- Transiciones Inteligentes --- */
        .bar-item {
            transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s ease;
        }
        
        /* --- Scrollbar Personalizada --- */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* --- ANIMACIÓN DE FONDO --- */
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Fondo Oscuro Elegante (Body) */
        .app-bg {
            background-color: #0f172a;
            background-image: 
                radial-gradient(circle at 50% 0%, #334155 0%, transparent 50%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
        }

        /* Fondo del Chart (Interior Móvil) */
        .chart-bg {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            position: relative;
        }
        
        /* Rejilla sutil */
        .chart-bg::after {
            content: "";
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 1; /* Encima de la imagen de fondo usuario */
        }

        /* Estilo para el fallback de texto en el logo */
        .logo-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: #1e293b;
            background-color: white;
            border-radius: 9999px;
            width: 100%;
            height: 100%;
            text-align: center;
            line-height: 1;
            border: 2px solid white;
        }
        
        /* Zoom y ajuste de imagen */
        .player-face {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* Chip de selección */
        .player-chip.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #2563eb;
        }
        
        .scene-btn.active {
            background-color: #e0f2fe; /* blue-100 */
            color: #0284c7; /* sky-600 */
            border-color: #7dd3fc;
        }

        /* Estilos para la paleta de colores */
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .color-swatch:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        .color-swatch.selected {
            transform: scale(1.2);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #0f172a;
            z-index: 20;
        }
    </style>
</head>
<body class="min-h-screen app-bg text-slate-100 font-sans py-8 px-4 flex flex-col items-center justify-center">

    <!-- Header -->
    <div class="w-full max-w-[400px] mb-4 flex justify-between items-center pb-2 z-10">
        <h1 class="text-xl font-bold text-slate-100 drop-shadow-md tracking-wide flex items-center gap-2">
            <i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-400"></i> Bar Chart Race
        </h1>
        <button id="toggle-editor-btn" class="flex items-center gap-2 text-xs text-blue-100 hover:text-white transition-colors font-medium bg-blue-900/50 backdrop-blur-md px-3 py-2 rounded-lg border border-blue-700/50 shadow-lg">
            <i data-lucide="settings" class="w-3.5 h-3.5"></i>
            <span id="editor-btn-text">Gestionar Datos</span>
        </button>
    </div>

    <!-- Editor Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="w-full max-w-5xl bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden animate-in fade-in zoom-in duration-300 h-[90vh] flex flex-col text-slate-800">
            
            <!-- Modal Header -->
            <div class="p-4 bg-slate-900 text-white flex justify-between items-center shrink-0 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="database" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">Gestión de Datos</h3>
                        <p class="text-xs text-slate-400">Importa JSON o edita manualmente</p>
                    </div>
                </div>
                <button id="close-editor-btn" class="hover:bg-slate-800 p-2 rounded-lg transition-colors text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Modal Body (Two Columns) -->
            <div class="flex flex-col md:flex-row h-full overflow-hidden bg-slate-50">
                
                <!-- Left Column: Navigation & List -->
                <div class="w-full md:w-1/3 bg-white border-r border-slate-200 flex flex-col h-full shrink-0">
                    
                    <!-- Top Actions -->
                    <div class="p-4 bg-slate-50 border-b border-slate-100 space-y-2">
                        <!-- Scene Settings Button -->
                        <button id="btn-edit-scene" class="scene-btn w-full py-2.5 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-sm">
                            <i data-lucide="image" class="w-4 h-4 text-purple-500"></i> Editar Fondo y Textos
                        </button>
                        
                        <div class="flex gap-2">
                             <button id="btn-trigger-upload" class="flex-grow py-2 bg-blue-50 border border-blue-100 text-blue-700 hover:bg-blue-100 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="upload" class="w-3 h-3"></i> Importar JSON
                            </button>
                             <input type="file" id="file-upload" class="hidden" accept=".json">
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="p-3 border-b border-slate-100 bg-white">
                        <div class="relative">
                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="text" id="search-player" placeholder="Buscar barra..." class="w-full pl-9 pr-4 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <!-- List -->
                    <div id="player-list" class="flex-grow overflow-y-auto p-2 space-y-1 custom-scrollbar">
                        <!-- Chips injected here -->
                    </div>
                    
                    <div class="p-4 border-t border-slate-100 bg-slate-50">
                        <button id="btn-new-player" class="w-full py-2 border border-slate-300 hover:bg-white text-slate-600 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i> Añadir Barra Manual
                        </button>
                    </div>
                </div>

                <!-- Right Column: Editors (Swappable) -->
                <div class="w-full md:w-2/3 overflow-hidden bg-white h-full relative">
                    
                    <!-- 1. PLAYER EDITOR (Default) -->
                    <div id="player-editor-wrapper" class="h-full flex flex-col overflow-y-auto custom-scrollbar p-6 md:p-8">
                        
                        <!-- Header -->
                        <div class="mb-6 flex justify-between items-end shrink-0">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <span id="editor-mode-title">Editar Barra</span>
                            </h2>
                            <span id="player-status-badge" class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded uppercase hidden">Nuevo</span>
                        </div>

                        <div class="space-y-6 flex-grow">
                            <!-- Visuals -->
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                <h4 class="text-sm font-bold text-slate-900 flex items-center gap-2 border-b border-slate-100 pb-2">
                                    <i data-lucide="palette" class="w-4 h-4 text-blue-600"></i> Apariencia
                                </h4>
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5">Nombre</label>
                                        <input type="text" id="edit-name" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5">Icono / URL Imagen</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="edit-image" placeholder="https://..." class="flex-grow p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs">
                                            <div class="w-10 h-10 shrink-0 rounded-full border border-slate-200 bg-slate-100 overflow-hidden relative">
                                                <img id="preview-image" src="" class="w-full h-full object-cover hidden">
                                                <i data-lucide="image" class="w-5 h-5 text-slate-300 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" id="preview-placeholder"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 mb-2">Color</label>
                                    <input type="hidden" id="edit-color-text">
                                    <div id="color-palette-container" class="grid grid-cols-5 gap-y-2 gap-x-1 p-3 bg-slate-50 rounded-lg border border-slate-100"></div>
                                </div>
                            </div>

                            <!-- Data -->
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <h4 class="text-sm font-bold text-slate-900 flex items-center gap-2">
                                        <i data-lucide="bar-chart" class="w-4 h-4 text-blue-600"></i> Datos Históricos
                                    </h4>
                                    <div class="flex gap-2">
                                         <input type="number" id="new-year-input" placeholder="Año" class="w-20 p-1.5 text-xs border border-slate-300 rounded text-center">
                                         <button id="btn-add-year" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs px-3 py-1.5 rounded font-bold transition-colors">+ Añadir</button>
                                    </div>
                                </div>
                                <div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                    <div class="grid grid-cols-4 bg-slate-100 p-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider text-center border-b border-slate-200">
                                        <div class="col-span-1">Año</div>
                                        <div class="col-span-2">Valor</div>
                                        <div class="col-span-1">Acción</div>
                                    </div>
                                    <div id="data-rows-container" class="max-h-60 overflow-y-auto custom-scrollbar p-1 space-y-1"></div>
                                </div>
                            </div>

                            <!-- Save -->
                            <div class="flex gap-3 pt-4 pb-8">
                                <button id="btn-save-player" class="flex-grow bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl transform active:scale-[0.98] flex justify-center items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
                                </button>
                                <button id="btn-download-json" class="px-4 py-3 border border-slate-300 text-slate-600 rounded-xl font-medium hover:bg-slate-50 transition-colors">
                                    <i data-lucide="code" class="w-5 h-5"></i>
                                </button>
                            </div>
                            
                            <div id="json-section" class="hidden pb-8">
                                <label class="block text-xs font-bold text-slate-500 mb-1">JSON Actual</label>
                                <textarea id="input-json" class="w-full h-32 border border-slate-300 rounded p-2 font-mono text-[10px] focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-slate-900 text-blue-400"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 2. SCENE EDITOR (Hidden) -->
                    <div id="scene-editor-wrapper" class="hidden h-full flex flex-col overflow-y-auto custom-scrollbar p-6 md:p-8 bg-slate-50/50">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="monitor" class="w-6 h-6 text-purple-600"></i> Configuración de Escena
                            </h2>
                            <p class="text-sm text-slate-500 mt-1">Personaliza los textos y el fondo del gráfico.</p>
                        </div>

                        <div class="space-y-6 max-w-lg">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-5">
                                <h4 class="text-sm font-bold text-slate-900 border-b border-slate-100 pb-2">Textos del Gráfico</h4>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Título Principal</label>
                                    <input type="text" id="scene-title-input" value="Ranking" class="w-full p-3 border border-slate-300 rounded-lg font-bold text-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Ej: Top Goleadores">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Subtítulo</label>
                                    <input type="text" id="scene-subtitle-input" value="Histórico" class="w-full p-3 border border-slate-300 rounded-lg font-medium text-slate-600 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Ej: 1990 - 2025">
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-5">
                                <h4 class="text-sm font-bold text-slate-900 border-b border-slate-100 pb-2">Fondo Personalizado</h4>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">URL Imagen de Fondo</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="scene-bg-input" class="flex-grow p-3 border border-slate-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-purple-500 outline-none" placeholder="https://...">
                                    </div>
                                    <p class="text-[10px] text-slate-500 mt-2 leading-relaxed">
                                        La imagen se superpondrá al fondo actual con transparencia. Deja este campo vacío para usar el fondo por defecto.
                                    </p>
                                </div>
                            </div>

                            <div class="p-4 bg-blue-50 text-blue-800 rounded-lg text-xs border border-blue-100 flex gap-3 items-start">
                                <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                <p>Los cambios en los textos y el fondo se aplican automáticamente en tiempo real mientras escribes.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Main Visualization Area -->
    <div id="visualization-area" class="w-full max-w-[400px] aspect-[9/16] chart-bg rounded-[2.5rem] shadow-2xl overflow-hidden relative border-8 border-slate-800 ring-4 ring-slate-700/50">
        
        <!-- User Background Layer (New) -->
        <div id="user-bg-layer" class="absolute inset-0 bg-cover bg-center pointer-events-none transition-opacity duration-500" style="z-index: 0; opacity: 0.4;"></div>

        <!-- Internal Header -->
        <div class="absolute top-5 left-0 right-0 px-8 py-6 z-20 pointer-events-none flex justify-end">
            <span id="year-display" class="text-7xl font-black text-white/90 tracking-tighter transition-all duration-300 drop-shadow-lg" style="text-shadow: 0 4px 12px rgba(0,0,0,0.4);">---</span>
        </div>

        <!-- Background Title -->
        <div class="absolute bottom-24 left-6 right-6 select-none pointer-events-none text-right" style="z-index: 2;">
            <h2 id="chart-title" class="text-3xl font-black text-white leading-tight drop-shadow-md transition-all">Ranking</h2>
            <p id="chart-subtitle" class="text-lg text-blue-200 font-medium drop-shadow-sm transition-all">Histórico</p>
        </div>

        <!-- Chart Area Container -->
        <div id="chart-container" class="relative w-full h-full px-6 pb-4 pt-36 z-10 box-border">
            <div id="empty-state-msg" class="absolute inset-0 flex flex-col items-center justify-center text-white/30 pointer-events-none pb-20">
                <i data-lucide="bar-chart-2" class="w-16 h-16 mb-4 opacity-50"></i>
                <p class="text-sm font-bold">Sin Datos</p>
                <p class="text-xs">Sube un JSON en Gestión</p>
            </div>
        </div>

        <!-- Timeline Slider -->
        <div class="absolute bottom-0 left-0 right-0 bg-black/40 backdrop-blur-lg p-4 border-t border-white/10 z-30 pb-6">
            <div class="flex items-center justify-between mb-2">
                 <span id="current-year-mini" class="text-xs font-bold text-white">---</span>
                 <span id="end-year-mini" class="text-xs font-bold text-white/70">---</span>
            </div>
            <input type="range" id="timeline-slider" min="0" max="100" step="0.01" value="0" class="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-blue-400 block" disabled>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="w-full max-w-[400px] mt-8 flex justify-between items-center bg-slate-900/90 backdrop-blur-xl p-4 rounded-2xl shadow-xl border border-slate-700/50 z-10">
        <button id="reset-btn" class="p-3 rounded-full hover:bg-white/10 text-slate-300 transition" title="Reiniciar">
            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
        </button>

        <button id="play-pause-btn" class="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-4 shadow-[0_0_20px_rgba(37,99,235,0.4)] transition-transform active:scale-95 flex items-center justify-center w-16 h-16 -mt-8 border-4 border-slate-900 disabled:opacity-50 disabled:cursor-not-allowed">
            <i id="play-icon" data-lucide="play" class="w-8 h-8 ml-1 fill-current"></i>
            <i id="pause-icon" data-lucide="pause" class="w-8 h-8 fill-current hidden"></i>
        </button>

        <div class="flex flex-col items-end">
            <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">Segundos por Año</span>
            <div class="flex items-center gap-2 bg-slate-800/50 px-3 py-1 rounded-lg border border-slate-700">
                <i data-lucide="clock" class="w-3.5 h-3.5 text-slate-300"></i>
                <input id="duration-input" type="number" min="0.1" max="10" step="0.1" value="1.5" class="bg-transparent text-xs font-bold text-blue-200 outline-none w-10 text-center border-none focus:ring-0">
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO INICIAL ---
        let PLAYER_COLORS = {};
        let PLAYER_IMAGES_SOURCES = {}; 
        let rawData = {};              
        
        const PROXY = "https://wsrv.nl/?url=";
        const PARAMS = "&w=200&h=200&fit=cover&a=top";

        const COLOR_PALETTE = {
            Gris:    ['#f1f5f9', '#cbd5e1', '#94a3b8', '#64748b', '#334155'], 
            Rojo:    ['#fee2e2', '#fca5a5', '#ef4444', '#b91c1c', '#7f1d1d'], 
            Naranja: ['#ffedd5', '#fdba74', '#f97316', '#c2410c', '#7c2d12'], 
            Amarillo:['#fef9c3', '#fde047', '#eab308', '#a16207', '#713f12'], 
            Verde:   ['#dcfce7', '#86efac', '#22c55e', '#15803d', '#14532d'], 
            Esmeralda:['#d1fae5', '#6ee7b7', '#10b981', '#047857', '#064e3b'], 
            Cian:    ['#cffafe', '#67e8f9', '#06b6d4', '#0e7490', '#155e75'], 
            Azul:    ['#dbeafe', '#93c5fd', '#3b82f6', '#1d4ed8', '#1e3a8a'], 
            Indigo:  ['#e0e7ff', '#a5b4fc', '#6366f1', '#4338ca', '#312e81'], 
            Rosa:    ['#fce7f3', '#f9a8d4', '#ec4899', '#be185d', '#831843'] 
        };

        // Estado Global de Animación
        let processedData = {};
        let yearKeys = [];
        let minYear = 0;
        let maxYear = 0;
        let currentYear = 0;
        let isPlaying = false;
        let lastTimestamp = 0;
        let animationFrameId = null;
        let editingPlayerName = null; 

        // Referencias DOM
        const els = {
            chartContainer: document.getElementById('chart-container'),
            emptyStateMsg: document.getElementById('empty-state-msg'),
            yearDisplay: document.getElementById('year-display'),
            timelineSlider: document.getElementById('timeline-slider'),
            currentYearMini: document.getElementById('current-year-mini'),
            endYearMini: document.getElementById('end-year-mini'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            playIcon: document.getElementById('play-icon'),
            pauseIcon: document.getElementById('pause-icon'),
            resetBtn: document.getElementById('reset-btn'),
            durationInput: document.getElementById('duration-input'),
            toggleEditorBtn: document.getElementById('toggle-editor-btn'),
            closeEditorBtn: document.getElementById('close-editor-btn'),
            editorModal: document.getElementById('editor-modal'),
            
            // Left Col
            playerList: document.getElementById('player-list'),
            searchPlayer: document.getElementById('search-player'),
            btnNewPlayer: document.getElementById('btn-new-player'),
            btnEditScene: document.getElementById('btn-edit-scene'), // New Button
            fileUpload: document.getElementById('file-upload'),
            btnTriggerUpload: document.getElementById('btn-trigger-upload'),

            // Right Col - Wrappers
            playerEditorWrapper: document.getElementById('player-editor-wrapper'),
            sceneEditorWrapper: document.getElementById('scene-editor-wrapper'),

            // Player Editor Inputs
            editName: document.getElementById('edit-name'),
            editColorText: document.getElementById('edit-color-text'),
            colorPaletteContainer: document.getElementById('color-palette-container'),
            editImage: document.getElementById('edit-image'),
            previewImage: document.getElementById('preview-image'),
            previewPlaceholder: document.getElementById('preview-placeholder'),
            dataRowsContainer: document.getElementById('data-rows-container'),
            newYearInput: document.getElementById('new-year-input'),
            btnAddYear: document.getElementById('btn-add-year'),
            btnSavePlayer: document.getElementById('btn-save-player'),
            btnDownloadJson: document.getElementById('btn-download-json'),
            jsonSection: document.getElementById('json-section'),
            inputJson: document.getElementById('input-json'),
            editorModeTitle: document.getElementById('editor-mode-title'),
            playerStatusBadge: document.getElementById('player-status-badge'),

            // Scene Editor Inputs
            sceneTitleInput: document.getElementById('scene-title-input'),
            sceneSubtitleInput: document.getElementById('scene-subtitle-input'),
            sceneBgInput: document.getElementById('scene-bg-input'),

            // Chart Visual Elements
            chartTitle: document.getElementById('chart-title'),
            chartSubtitle: document.getElementById('chart-subtitle'),
            userBgLayer: document.getElementById('user-bg-layer')
        };

        const barElements = {};
        const ROW_HEIGHT = 58;
        const OFFSET_TOP = 150;

        // --- SCENE SETTINGS LOGIC ---
        function switchEditorMode(mode) {
            if (mode === 'scene') {
                els.playerEditorWrapper.classList.add('hidden');
                els.sceneEditorWrapper.classList.remove('hidden');
                
                // Styles for button
                els.btnEditScene.classList.add('active', 'border-blue-200');
                els.btnEditScene.classList.remove('bg-white', 'text-slate-700');
                
                // Deselect players in list
                document.querySelectorAll('.player-chip').forEach(el => el.classList.remove('active'));
                editingPlayerName = null;
            } else {
                els.sceneEditorWrapper.classList.add('hidden');
                els.playerEditorWrapper.classList.remove('hidden');
                
                // Reset button style
                els.btnEditScene.classList.remove('active', 'border-blue-200');
                els.btnEditScene.classList.add('bg-white', 'text-slate-700');
            }
        }

        els.btnEditScene.addEventListener('click', () => switchEditorMode('scene'));

        // Real-time Text Updates
        els.sceneTitleInput.addEventListener('input', (e) => {
            els.chartTitle.innerText = e.target.value || "Ranking";
        });
        
        els.sceneSubtitleInput.addEventListener('input', (e) => {
            els.chartSubtitle.innerText = e.target.value || "";
        });

        // Background Image Update
        els.sceneBgInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
                // Use Proxy for safety if needed, or direct
                // Let's use direct first, user can check if it works
                els.userBgLayer.style.backgroundImage = `url('${url}')`;
            } else {
                els.userBgLayer.style.backgroundImage = 'none';
            }
        });

        // --- UTILS ---
        const getPlayerColor = (name) => PLAYER_COLORS[name] || '#94a3b8';
        const getPlayerImageURL = (name, index = 0) => {
            const sources = PLAYER_IMAGES_SOURCES[name];
            if (!sources || !sources[index]) return null;
            return PROXY + encodeURIComponent(sources[index]) + PARAMS;
        };

        // --- DATA PROCESSING & ANIMATION ENGINE (Same as before) ---
        const preprocessData = (inputData) => {
            const years = Object.keys(inputData).map(Number).sort((a, b) => a - b);
            if (years.length === 0) return {};
            const allPlayers = new Set();
            Object.values(inputData).forEach(yearList => yearList.forEach(item => allPlayers.add(item.name)));
            const filledData = {};
            const lastValues = {}; 
            allPlayers.forEach(p => lastValues[p] = 0);
            years.forEach(year => {
                const currentMap = {};
                (inputData[year] || []).forEach(item => currentMap[item.name] = item.value);
                const newYearList = [];
                allPlayers.forEach(player => {
                    let val = currentMap[player] !== undefined ? currentMap[player] : lastValues[player];
                    val = Math.max(val, lastValues[player]);
                    lastValues[player] = val;
                    if (val > 0) newYearList.push({ name: player, value: val });
                });
                filledData[year] = newYearList;
            });
            return filledData;
        };

        function getDataAtYear(yearFloat) {
            if (yearKeys.length === 0) return [];
            if (yearFloat <= minYear) return processedData[minYear];
            if (yearFloat >= maxYear) return processedData[maxYear];
            let prevYear = minYear;
            let nextYear = maxYear;
            for (let i = 0; i < yearKeys.length - 1; i++) {
                if (yearKeys[i] <= yearFloat && yearKeys[i+1] >= yearFloat) {
                    prevYear = yearKeys[i];
                    nextYear = yearKeys[i+1];
                    break;
                }
            }
            const prevList = processedData[prevYear];
            const nextList = processedData[nextYear];
            const range = nextYear - prevYear;
            const progress = range === 0 ? 0 : (yearFloat - prevYear) / range;
            const prevMap = new Map(prevList.map(i => [i.name, i.value]));
            const nextMap = new Map(nextList.map(i => [i.name, i.value]));
            const allNames = new Set([...prevMap.keys(), ...nextMap.keys()]);
            const result = [];
            allNames.forEach(name => {
                const startVal = prevMap.get(name) || 0;
                const endVal = nextMap.get(name) || startVal; 
                const currentVal = startVal + (endVal - startVal) * progress;
                if (currentVal > 0) {
                    result.push({ name, value: currentVal });
                }
            });
            return result;
        }

        function initData() {
            if (Object.keys(rawData).length === 0) {
                resetEmptyState();
                return;
            }
            els.emptyStateMsg.classList.add('hidden');
            els.playPauseBtn.disabled = false;
            els.timelineSlider.disabled = false;
            processedData = preprocessData(rawData);
            yearKeys = Object.keys(processedData).map(Number).sort((a, b) => a - b);
            if (yearKeys.length > 0) {
                minYear = yearKeys[0];
                maxYear = yearKeys[yearKeys.length - 1];
                els.timelineSlider.min = minYear;
                els.timelineSlider.max = maxYear;
                els.currentYearMini.innerText = minYear;
                els.endYearMini.innerText = maxYear;
                currentYear = minYear;
                renderFrame(currentYear);
                els.timelineSlider.value = minYear;
            }
            updateJsonEditor();
        }

        function resetEmptyState() {
            processedData = {};
            yearKeys = [];
            els.emptyStateMsg.classList.remove('hidden');
            els.playPauseBtn.disabled = true;
            els.timelineSlider.disabled = true;
            els.yearDisplay.innerText = "---";
            els.currentYearMini.innerText = "---";
            els.endYearMini.innerText = "---";
            els.inputJson.value = "[]";
            renderPlayerList();
        }

        function gameLoop(timestamp) {
            if (!isPlaying) return;
            if (!lastTimestamp) lastTimestamp = timestamp;
            const dt = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            const secondsPerYear = parseFloat(els.durationInput.value) || 2;
            const yearsPerMs = 1 / (secondsPerYear * 1000);
            currentYear += dt * yearsPerMs;
            if (currentYear >= maxYear) {
                currentYear = maxYear;
                pauseGame();
            }
            renderFrame(currentYear);
            els.timelineSlider.value = currentYear;
            if (isPlaying) {
                animationFrameId = requestAnimationFrame(gameLoop);
            }
        }

        function renderFrame(yearVal) {
            const data = getDataAtYear(yearVal);
            if (data.length === 0) return;
            data.sort((a, b) => b.value - a.value);
            const maxValue = data[0].value || 1;
            els.yearDisplay.innerText = Math.floor(yearVal);
            const activeItems = data.slice(0, 10).map((item, index) => ({
                ...item,
                rank: index,
                barWidth: (item.value / maxValue) * 100,
                color: getPlayerColor(item.name),
                imageUrl: getPlayerImageURL(item.name, 0)
            }));
            const activeNames = new Set(activeItems.map(i => i.name));
            activeItems.forEach(item => {
                let el = barElements[item.name];
                if (!el) {
                    el = document.createElement('div');
                    el.className = "absolute left-6 right-6 flex items-center bar-item"; 
                    el.innerHTML = `
                        <div class="absolute -top-5 left-0 text-xs font-bold text-white drop-shadow-md truncate max-w-[200px] shadow-black" style="text-shadow: 0 1px 2px rgba(0,0,0,0.8);">${item.name}</div>
                        <div class="w-full h-10 relative flex items-center">
                            <div class="bar-fill h-full rounded-r-full shadow-lg flex items-center pl-2 overflow-visible whitespace-nowrap relative border border-white/40">
                                <div class="party-logo-container w-10 h-10 rounded-full absolute -right-5 border-2 border-white shadow-md z-10 bg-white overflow-hidden hidden ring-2 ring-black/20">
                                    <img src="" referrerpolicy="no-referrer" class="player-face w-full h-full" 
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                        onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
                                    >
                                    <div class="logo-fallback hidden" style="color:${getPlayerColor(item.name)}">${item.name.substring(0,2)}</div>
                                </div>
                            </div>
                            <span class="value-label ml-2 text-sm font-bold text-white tabular-nums z-20 shadow-lg bg-black/40 backdrop-blur-md px-2 py-0.5 rounded-full border border-white/20">0</span>
                        </div>
                    `;
                    els.chartContainer.appendChild(el);
                    barElements[item.name] = el;
                }
                el.style.top = `${(item.rank * ROW_HEIGHT) + OFFSET_TOP}px`;
                el.style.opacity = '1';
                const barFill = el.querySelector('.bar-fill');
                barFill.style.width = `${Math.max(item.barWidth, 1)}%`;
                barFill.style.backgroundColor = item.color;
                barFill.style.backgroundImage = "linear-gradient(to bottom, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%)";
                const containerEl = el.querySelector('.party-logo-container');
                const imgEl = containerEl.querySelector('img');
                const fallbackEl = containerEl.querySelector('.logo-fallback');
                if (item.imageUrl) {
                    if (imgEl.dataset.src !== item.imageUrl) {
                        imgEl.src = item.imageUrl;
                        imgEl.dataset.src = item.imageUrl;
                    }
                    containerEl.classList.remove('hidden');
                } else {
                    imgEl.style.display = 'none';
                    fallbackEl.style.display = 'flex';
                    containerEl.classList.remove('hidden');
                }
                fallbackEl.style.color = item.color;
                const valLabel = el.querySelector('.value-label');
                valLabel.innerText = Math.round(item.value);
            });
            Object.keys(barElements).forEach(name => {
                if (!activeNames.has(name)) {
                    const el = barElements[name];
                    el.style.opacity = '0';
                    el.style.top = '600px'; 
                }
            });
        }

        function startGame() {
            if (isPlaying) return;
            isPlaying = true;
            lastTimestamp = 0;
            if (currentYear >= maxYear) {
                currentYear = minYear;
            }
            updatePlayButton();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function pauseGame() {
            isPlaying = false;
            cancelAnimationFrame(animationFrameId);
            updatePlayButton();
        }

        function updatePlayButton() {
            if (isPlaying) {
                els.playIcon.classList.add('hidden');
                els.pauseIcon.classList.remove('hidden');
            } else {
                els.playIcon.classList.remove('hidden');
                els.pauseIcon.classList.add('hidden');
            }
        }

        els.playPauseBtn.addEventListener('click', () => {
            if (isPlaying) pauseGame();
            else startGame();
        });
        els.resetBtn.addEventListener('click', () => {
            pauseGame();
            currentYear = minYear;
            renderFrame(currentYear);
            els.timelineSlider.value = minYear;
        });
        els.timelineSlider.addEventListener('input', (e) => {
            pauseGame();
            currentYear = parseFloat(e.target.value);
            renderFrame(currentYear);
        });

        // --- IMPORTACIÓN Y EDICIÓN MANUAL ---
        els.btnTriggerUpload.onclick = () => els.fileUpload.click();
        els.fileUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const json = JSON.parse(evt.target.result);
                    parseUserJson(json);
                    initData();
                    renderPlayerList();
                    alert("Datos importados correctamente.");
                } catch (err) {
                    alert("Error al leer JSON: " + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        function parseUserJson(userJson) {
            rawData = {};
            if (!Array.isArray(userJson)) throw new Error("JSON debe ser Array");
            userJson.forEach(entity => {
                const name = entity.name;
                if (!name) return;
                const history = entity.data || entity.history || entity.values || [];
                if (Array.isArray(history)) {
                    history.forEach(pt => {
                        const year = String(pt.year);
                        const val = parseFloat(pt.value);
                        if (!rawData[year]) rawData[year] = [];
                        rawData[year].push({ name, value: val });
                    });
                }
            });
        }

        function updateJsonEditor() {
            const exportData = [];
            const allNames = new Set();
            Object.values(rawData).forEach(l => l.forEach(i => allNames.add(i.name)));
            allNames.forEach(name => {
                const hist = [];
                Object.keys(rawData).sort().forEach(y => {
                    const entry = rawData[y].find(p => p.name === name);
                    if(entry) hist.push({ year: parseInt(y), value: entry.value });
                });
                if(hist.length) exportData.push({ name, data: hist });
            });
            els.inputJson.value = JSON.stringify(exportData, null, 2);
        }

        function renderColorPalette() {
            els.colorPaletteContainer.innerHTML = '';
            Object.entries(COLOR_PALETTE).forEach(([name, shades]) => {
                shades.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = color;
                    swatch.dataset.color = color;
                    swatch.onclick = () => selectColor(color);
                    els.colorPaletteContainer.appendChild(swatch);
                });
            });
        }

        function selectColor(color) {
            els.editColorText.value = color;
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('selected', s.dataset.color === color);
            });
        }

        function getAllPlayerNames() {
            const names = new Set();
            Object.values(rawData).forEach(list => list.forEach(i => names.add(i.name)));
            return Array.from(names).sort();
        }

        function renderPlayerList(filter = "") {
            els.playerList.innerHTML = "";
            const players = getAllPlayerNames();
            if (players.length === 0) {
                els.playerList.innerHTML = `
                    <div class="p-8 text-center text-slate-400 text-sm">
                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p>Sin datos.</p>
                        <p class="text-xs mt-1">Importa un JSON o añade manualmente.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }
            players.forEach(name => {
                if (filter && !name.toLowerCase().includes(filter.toLowerCase())) return;
                const color = getPlayerColor(name);
                const btn = document.createElement("button");
                btn.className = "player-chip w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors flex items-center gap-3 border border-transparent";
                if (editingPlayerName === name) btn.classList.add("active");
                
                btn.innerHTML = `<div class="w-3 h-3 rounded-full shadow-sm" style="background-color: ${color}"></div><span class="truncate">${name}</span>`;
                btn.onclick = () => loadPlayerIntoEditor(name);
                els.playerList.appendChild(btn);
            });
        }

        function loadPlayerIntoEditor(name) {
            // Force switch to player mode
            switchEditorMode('player');
            
            editingPlayerName = name;
            els.editorModeTitle.innerText = "Editar Barra";
            els.playerStatusBadge.classList.add("hidden");
            els.editName.value = name;
            els.editName.readOnly = true; 
            els.editName.classList.add("bg-slate-50", "text-slate-500");
            selectColor(getPlayerColor(name));
            const imgSrc = PLAYER_IMAGES_SOURCES[name] ? PLAYER_IMAGES_SOURCES[name][0] : "";
            els.editImage.value = imgSrc;
            updateImagePreview(imgSrc);
            renderDataRows(name);
            renderPlayerList(els.searchPlayer.value);
        }

        function clearEditor() {
            // Force switch to player mode
            switchEditorMode('player');

            editingPlayerName = null;
            els.editorModeTitle.innerText = "Nueva Barra";
            els.playerStatusBadge.classList.remove("hidden");
            els.editName.value = "";
            els.editName.readOnly = false;
            els.editName.classList.remove("bg-slate-50", "text-slate-500");
            selectColor('#94a3b8');
            els.editImage.value = "";
            updateImagePreview("");
            els.dataRowsContainer.innerHTML = '<div class="p-4 text-center text-xs text-slate-400 italic">Crea la barra para añadir datos</div>';
            renderPlayerList(els.searchPlayer.value);
        }

        function updateImagePreview(url) {
             const show = !!url;
             els.previewImage.src = show ? (PROXY + encodeURIComponent(url) + PARAMS) : "";
             els.previewImage.classList.toggle("hidden", !show);
             els.previewPlaceholder.classList.toggle("hidden", show);
        }

        function renderDataRows(name) {
            els.dataRowsContainer.innerHTML = '';
            const years = Object.keys(rawData).sort();
            const rows = [];
            years.forEach(y => {
                const entry = rawData[y].find(p => p.name === name);
                if(entry) rows.push({year: y, value: entry.value});
            });
            if (rows.length === 0) {
                 els.dataRowsContainer.innerHTML = '<div class="p-2 text-center text-xs text-slate-400">Sin datos registrados</div>';
                 return;
            }
            rows.forEach(item => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-4 gap-2 items-center p-1 border-b border-slate-100 bg-white hover:bg-slate-50 transition-colors rounded';
                row.innerHTML = `
                    <div class="col-span-1 text-center font-mono text-xs text-slate-600 font-bold">${item.year}</div>
                    <div class="col-span-2">
                        <input type="number" value="${item.value}" class="w-full text-right p-1 text-xs border border-slate-200 rounded font-bold text-slate-700 focus:ring-1 focus:ring-blue-500 outline-none" 
                        onchange="updateDataValue('${item.year}', this.value)">
                    </div>
                    <div class="col-span-1 flex justify-center">
                        <button class="text-slate-400 hover:text-red-500 transition-colors p-1" onclick="deleteDataYear('${item.year}')">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                `;
                els.dataRowsContainer.appendChild(row);
            });
            lucide.createIcons();
        }
        
        window.updateDataValue = (year, val) => {
            if(!editingPlayerName) return;
            const num = parseFloat(val);
            if(isNaN(num)) return;
            const entry = rawData[year].find(p => p.name === editingPlayerName);
            if(entry) entry.value = num;
        };
        
        window.deleteDataYear = (year) => {
             if (!editingPlayerName || !confirm(`¿Borrar año ${year}?`)) return;
             rawData[year] = rawData[year].filter(p => p.name !== editingPlayerName);
             if (rawData[year].length === 0) delete rawData[year];
             renderDataRows(editingPlayerName);
        };

        // Events
        els.btnNewPlayer.onclick = () => { clearEditor(); els.editName.focus(); };
        els.searchPlayer.oninput = (e) => renderPlayerList(e.target.value);
        els.editImage.onchange = (e) => updateImagePreview(e.target.value);
        els.btnDownloadJson.onclick = () => els.jsonSection.classList.toggle("hidden");
        
        els.btnAddYear.onclick = () => {
            if (!editingPlayerName) return alert("Selecciona una barra");
            const year = els.newYearInput.value;
            if(!year) return;
            if(!rawData[year]) rawData[year] = [];
            if(rawData[year].find(p => p.name === editingPlayerName)) {
                alert("Año ya existe");
            } else {
                rawData[year].push({name: editingPlayerName, value: 0});
                renderDataRows(editingPlayerName);
            }
            els.newYearInput.value = '';
        };

        els.btnSavePlayer.onclick = () => {
            const name = els.editName.value;
            if(!name) return alert("Falta nombre");
            PLAYER_COLORS[name] = els.editColorText.value;
            if(els.editImage.value) PLAYER_IMAGES_SOURCES[name] = [els.editImage.value];
            if(!getAllPlayerNames().includes(name)) {
                const firstY = Object.keys(rawData).sort()[0] || new Date().getFullYear().toString();
                if(!rawData[firstY]) rawData[firstY] = [];
                rawData[firstY].push({name, value: 0});
            }
            initData();
            editingPlayerName = name; 
            renderPlayerList(els.searchPlayer.value);
            const oldTxt = els.btnSavePlayer.innerHTML;
            els.btnSavePlayer.innerHTML = "Guardado";
            setTimeout(() => els.btnSavePlayer.innerHTML = oldTxt, 1000);
        };

        els.toggleEditorBtn.addEventListener('click', () => {
            els.editorModal.classList.remove('hidden');
            renderPlayerList();
            if(!editingPlayerName) clearEditor();
        });
        els.closeEditorBtn.addEventListener('click', () => els.editorModal.classList.add('hidden'));

        // Init
        renderColorPalette();
        lucide.createIcons();
        initData();
    </script>
</body>
</html>
